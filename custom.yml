---
name: Starfunkel Chainsaw rules
# comments are meant to connect evtx attribute to mapping rule to csv collum name
kind: evtx
rules: sigma

exclusions:

- Defense evasion via process reimaging
- Exports Registry Key To an Alternate Data Stream
- NetNTLM Downgrade Attack
- Non Interactive PowerShell
- Wuauclt Network Connection
- Raw Disk Access Using Illegitimate Tools
- Executable in ADS
- Space After Filename - macOS
- Execution Of Non-Existing File
- Execution of Suspicious File Type Extension
- Execution from Suspicious Folder
- Process Start From Suspicious Folder
- Setting Change in Windows Firewall with Advanced Security
- Group Modification Logging
- WMI Event Subscription
- USB Device Plugged

extensions:
  preconditions:
    - for:
        logsource.category: process_creation
      filter:
        - Provider: Microsoft-Windows-Sysmon
          int(EventID): 1
        - Provider: Microsoft-Windows-Security-Auditing
          int(EventID): 4688
    - for:
        logsource.category: network_connection
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 3
    - for:
        logsource.category: sysmon_status
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID):
        - 4
        - 16
    - for:
        logsource.category: process_termination
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 5
    - for:
        logsource.category: driver_load
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 6
    - for:
        logsource.category: image_load
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 7
    - for:
        logsource.category: create_remote_thread
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 8
    - for:
        logsource.category: raw_access_thread
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 9
    - for:
        logsource.category: process_access
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 10
    - for:
        logsource.category: file_event
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 11
    - for:
        logsource.category: registry_event
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID):
        - 12
        - 13
        - 14
    - for:
        logsource.category: registry_add
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 12
    - for:
        logsource.category: registry_delete
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 12
    - for:
        logsource.category: registry_set
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 13
    - for:
        logsource.category: registry_rename
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 14
    - for:
        logsource.category: create_stream_hash
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 15
    - for:
        logsource.category: pipe_created
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID):
        - 17
        - 18
    - for:
        logsource.category: wmi_event
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID):
        - 19
        - 20
        - 21
    - for:
        logsource.category: dns_query
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 22
    - for:
        logsource.category: file_delete
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 23
    - for:
        logsource.category: clipboard_change
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 24
    - for:
        logsource.category: process_tampering
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 25
    - for:
        logsource.category: file_delete_detected
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 26
    - for:
        logsource.category: file_block
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 27
    - for:
        logsource.category: file_block_executable
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 27
    - for:
        logsource.category: file_block_shredding
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 28
    - for:
        logsource.category: file_executable_detected
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 29
    - for:
        logsource.category: sysmon_error
      filter:
        Provider: Microsoft-Windows-Sysmon
        int(EventID): 255
    - for:
        logsource.service: windefend
      filter:
        Provider: Microsoft-Windows-Windows Defender
    - for:
        logsource.service: sysmon
      filter:
        Provider: Microsoft-Windows-Sysmon
    - for:
        logsource.service: capi2
      filter:
        Provider: Microsoft-Windows-CAPI2
    - for:
        logsource.service: applocker
      filter:
        Provider: Microsoft-Windows-AppLocker
    - for:
        logsource.service: codeintegrity-operational
      filter:
        Provider: Microsoft-Windows-CodeIntegrity
    - for:
        logsource.service: firewall-as
      filter:
        Provider: Microsoft-Windows-Windows Firewall With Advanced Security
    - for:
        logsource.service: security
      filter:
        Provider: Microsoft-Windows-Security-Auditing
    - for:
        logsource.service: appxdeployment-server
      filter:
        Provider: Microsoft-Windows-AppXDeployment-Server
    - for:
        logsource.service: bits-client
      filter:
        Provider: Microsoft-Windows-Bits-Client
    - for:
        logsource.service: certificateservicesclient-lifecycle-system
      filter:
        Provider: Microsoft-Windows-CertificateServicesClient-Lifecycle-System
    - for:
        logsource.service: ntlm
      filter:
        Provider: Microsoft-Windows-NTLM
    - for:
        logsource.service: smbclient-security
      filter:
        Provider: Microsoft-Windows-SMBClient
    - for:
        logsource.service: smbclient-connectivity
      filter:
        Provider: Microsoft-Windows-SMBClient
    - for:
        logsource.service: appmodel-runtime
      filter:
        Provider: Microsoft-Windows-AppModel-Runtime
    - for:
        logsource.service: security-mitigations
      filter:
        Provider: Microsoft-Windows-Security-Mitigations
    - for:
        logsource.service: taskscheduler
      filter:
        Provider: Microsoft-Windows-TaskScheduler
    - for:
        logsource.service: wmi
      filter:
        Provider: Microsoft-Windows-WMI-Activity
    - for:
        logsource.service: dhcp
      filter:
        Provider: Microsoft-Windows-DHCP-Server
    - for:
        logsource.service: printservice-admin
      filter:
        Provider: Microsoft-Windows-PrintService
    - for:
        logsource.service: printservice-operational
      filter:
        Provider: Microsoft-Windows-PrintService
    - for:
        logsource.service: terminalservices-localsessionmanager
      filter:
        Provider: Microsoft-Windows-TerminalServices-LocalSessionManager
    - for:
        logsource.service: diagnosis-scripted
      filter:
        Provider: Microsoft-Windows-Diagnosis-Scripted
    - for:
        logsource.service: shell-core
      filter:
        Provider: Microsoft-Windows-Shell-Core
    - for:
        logsource.service: openssh
      filter:
        Provider: OpenSSH
    - for:
        logsource.service: ldap
      filter:
        Provider: Microsoft-Windows-LDAP-Client
    - for:
        logsource.service: ldap_debug
      filter:
        Provider: Microsoft-Windows-LDAP-Client
    - for:
        logsource.service: dns-client
      filter:
        Provider: Microsoft-Windows-DNS-Client
    - for:
        logsource.service: dns-server
      filter:
        Provider: Microsoft-Windows-DNS-Server-Service
    - for:
        logsource.service: appxpackaging-om
      filter:
        Provider: Microsoft-Windows-AppxPackagingOM
    - for:
        logsource.service: lsa-server
      filter:
        Provider: LsaSrv
    - for:
        logsource.service: kernel-shimengine
      filter:
        Provider: Microsoft-Windows-Kernel-ShimEngine
    - for:
        logsource.service: application-experience
      filter:
        Provider: Microsoft-Windows-Application-Experience
    - for:
        logsource.service: ntfs
      filter:
        Provider: Microsoft-Windows-Ntfs
    - for:
        logsource.service: hyper-v-worker
      filter:
        Provider: Microsoft-Windows-Hyper-V-Worker
    - for:
        logsource.service: driver-framework
      filter:
        Provider: Microsoft-Windows-DriverFrameworks-UserMode
    - for:
        logsource.service: msexchange-management
      filter:
        Provider: MSExchange CmdletLogs
    - for:
        id: 4a3a2b96-d7fc-4cb9-80e4-4a545fe95f46 #Remote Service Creation Rule
      filter:
        - Provider: Microsoft-Windows-Security-Auditing
        - Provider: System
#                                                   evtx                          csv
groups:
  - name: Sigma
    timestamp: Event.System.TimeCreated           #TimeCreated_attributes:        timestamp
    filter:
      Provider: "*"                               # consume all
    fields:
      - from: Provider
        to: Event.System.Provider                 #Provider_attributes: Name:     Event.System.Provider
      - name: Event ID
        from: EventID
        to: Event.System.EventID                  #EventID                        Event ID
      - name: Record ID
        from: EventRecordID
        to: Event.System.EventRecordID            #EventRecordID                  Record ID
      - name: Computer
        from: Computer
        to: Event.System.Computer                 #Computer                       Computer
      - name: Event Data
        from: EventData
        to: Event.EventData                       #EventData                      EventData  ---> This is the multiline blob in collumn I

   
      - from: AuthenticationPackageName
        to: Event.EventData.AuthenticationPackageName
        visible: true
      - from: IpAddress
        to: Event.EventData.IpAddress
        visible: true
      - from: LogonProcessName
        to: Event.EventData.LogonProcessName
        visible: true
      - from: LogonType
        to: Event.EventData.LogonType
        visible: true
      - from: ProcessId
        to: Event.EventData.ProcessId
        visible: true
      - from: ProcessName
        to: Event.EventData.ProcessName
        visible: true
      - from: Status
        to: Event.EventData.Status
        visible: true
      - from: TargetUserName
        to: Event.EventData.TargetUserName
        visible: true
      - from: TargetUserSid
        to: Event.EventData.TargetUserSid
        visible: true
      - from: WorkstationName
        to: Event.EventData.WorkstationName
        visible: true
